#

text_items__feuer = [
  {
    "text": "Feuer",
    "box": [40, 320, 820, 350],
    "size": 22,
    "color": "red",
    "style": "bold"
  },
  {
    "text": "Vorsorge für den Brandfall",
    "box": [40, 360, 820, 380],
    "size": 18,
    "color": "black",
    "style": "bold"
  },
  {
    "text": "Die Brandgefahr kann erheblich minimiert werden, indem sich richtig um Kerzen, \nbrennbares Material, Rauchmelder und Löschgeräte gekümmert wird.",
    "box": [40, 390, 820, 440],
    "size": 15,
    "color": "black",
    "style": "normal"
  },
  {
    "text": "Was tun, wenn es brennt?",
    "box": [40, 455, 820, 475],
    "size": 18,
    "color": "black",
    "style": "bold"
  },
  {
    "text": "Ersticken Sie wenn möglich das Feuer im Keim. Falls erfolglos: rufen Sie die 112 an! \nLöschen Sie nur, wenn keine Gefahr besteht oder bringen Sie sich in Sicherheit.",
    "box": [40, 485, 820, 535],
    "size": 15,
    "color": "black",
    "style": "normal"
  },
  {
    "text": "Nach dem Brand",
    "box": [40, 550, 820, 570],
    "size": 18,
    "color": "black",
    "style": "bold"
  },
  {
    "text": "Betreten Sie das Gebäude nur, wenn es von der Feuerwehr freigegeben wurde. \nEs könnte Einsturzgefahr bestehen. Machen Sie nach Freigabe eine Bestandsaufnahme \nund fotografieren Sie Schäden als Beleg für die Versicherung.",
    "box": [40, 580, 820, 640],
    "size": 15,
    "color": "black",
    "style": "normal"
  }
]


text_items__gewitter = [
  {
    "text": "Unwetter",
    "box": [40, 320, 820, 350],
    "size": 22,
    "color": "red",
    "style": "bold"
  },
  {
    "text": "Vorsorge bei Unwetter",
    "box": [40, 360, 820, 380],
    "size": 17,
    "color": "black",
    "style": "bold"
  },
  {
    "text": "Bereiten Sie sich frühzeitig auf Unwetter vor, indem Sie genügend Lebensmittel, Wasser, \nDokumententasche und Notfallkoffer bereit halten.",
    "box": [40, 390, 820, 450],
    "size": 15,
    "color": "black",
    "style": "normal"
  },
  {
    "text": "Was tun bei Unwetter?",
    "box": [40, 465, 820, 485],
    "size": 17,
    "color": "black",
    "style": "bold"
  },
  {
    "text": "Gegenstände sichern, Fenster schließen, Metall vermeiden: je nach Aufenthaltsort \nherrschen unterschiedliche Verhaltensregeln. Als goldene Regel gilt jedoch: zu Hause \nbleiben.",
    "box": [40, 495, 820, 565],
    "size": 15,
    "color": "black",
    "style": "normal"
  },
  {
    "text": "Nach dem Unwetter",
    "box": [40, 580, 820, 600],
    "size": 17,
    "color": "black",
    "style": "bold"
  },
  {
    "text": "Unwetter können zu Dachschäden, Überflutungen, dem Austritt von Gefahrenstoffen führen \nund Personen verletzen. Je nach Art des Unwetters sind unterschiedliche Tipps zu \nbeachten.",
    "box": [40, 610, 820, 670],
    "size": 15,
    "color": "black",
    "style": "normal"
  }
]

text_items__vorsorge = [
  {
    "text": "Persönliche Vorsorge",
    "box": [40, 320, 820, 350],
    "size": 22,
    "color": "red",
    "style": "bold"
  },
  {
    "text": "Essen und Trinken",
    "box": [40, 365, 820, 390],
    "size": 18,
    "color": "black",
    "style": "bold"
  },
  {
    "text": "Wir empfehlen einen Vorrat an Lebensmitteln für mind. 3 Tage pro Person. Des weiteren \nsollten Sie mind. 1,5l Trinkwasser und 0,5l Wasser pro Tag zum Kochen und für Hygiene \neinplanen.",
    "box": [40, 400, 820, 460],
    "size": 15,
    "color": "black",
    "style": "normal"
  },
  {
    "text": "Hygiene und Medikamente",
    "box": [40, 485, 820, 510],
    "size": 18,
    "color": "black",
    "style": "bold"
  },
  {
    "text": "Durch einen sparsamen Umgang mit Wasser und eine gut sortierte Hausapotheke kann \ngesundheitsfördernde Hygiene und Erste Hilfe selbstständig sichergestellt werden.",
    "box": [40, 520, 820, 580],
    "size": 15,
    "color": "black",
    "style": "normal"
  }
]


text_items__hochwasser = [
  {
    "text": "Hochwasser",
    "box": [40, 320, 820, 350],
    "size": 22,
    "color": "red",
    "style": "bold"
  },
  {
    "text": "Generell gilt:",
    "box": [40, 360, 820, 380],
    "size": 17,
    "color": "black",
    "style": "bold"
  },
  {
    "text": "Achten Sie auf die Informationen Ihrer lokalen Gefahrenabwehrbehörden und unterstützen \nSie die Einsatzkräfte vor Ort, indem Sie deren Anweisungen umsetzen und sich von \ngefährdeten oder bereits abgeriegelten Gebieten fernhalten.",
    "box": [40, 390, 820, 450],
    "size": 15,
    "color": "black",
    "style": "normal"
  },
  {
    "text": "Vorsorge für das Hochwasser",
    "box": [40, 465, 820, 485],
    "size": 17,
    "color": "black",
    "style": "bold"
  },
  {
    "text": "Evakuieren Sie Hilfebedürftige, Kinder und Haustiere. Informieren Sie sich über die \nHochwasserzentrale der Länder über aktuelle Informationen.",
    "box": [40, 495, 820, 545],
    "size": 15,
    "color": "black",
    "style": "normal"
  },
  {
    "text": "Was tun bei Hochwasser?",
    "box": [40, 560, 820, 580],
    "size": 17,
    "color": "black",
    "style": "bold"
  },
  {
    "text": "Der Keller oder die Tiefgarage können zur Lebensgefahr werden. \nDabei herrschen im Haus und im Auto unterschiedliche Verhaltensregeln.",
    "box": [40, 590, 820, 640],
    "size": 15,
    "color": "black",
    "style": "normal"
  }
]

text_items__gefahrenstoffe = [
  {
    "text": "CBRN-Gefahrenstoffe",
    "box": [40, 320, 820, 345],
    "size": 22,
    "color": "red",
    "style": "bold"
  },
  {
    "text": "Die unterschiedlichen Gefahrenstoffe",
    "box": [40, 355, 820, 370],
    "size": 15,
    "color": "black",
    "style": "bold"
  },
  {
    "text": "Ein Laie kann in der Regel die Gefährlichkeit von chemischen (C), biologischen (B),  radiologischen (R) und nuklearen (N) Gefahrenstoffen nicht erkennen.",
    "box": [40, 375, 820, 410],
    "size": 14,
    "color": "black",
    "style": "normal"
  },
  {
    "text": "Wirkung auf Haut und Körper",
    "box": [40, 420, 820, 440],
    "size": 15,
    "color": "black",
    "style": "bold"
  },
  {
    "text": "Verhalten bei Gefahrenstoff-Freisetzung. Kontaktieren Sie die lokale Giftnotrufzentrale.",
    "box": [40, 445, 820, 470],
    "size": 14, 
    "color": "black",
    "style": "normal"
  },
  {
    "text": "Giftnotruf der Charité Universitätsmedizin Berlin:",
    "box": [40, 470, 650, 495],
    "size": 14,
    "color": "black",
    "style": "normal"
  },
  {
    "text": "030 192 40",
    "box": [468, 470, 820, 495],
    "size": 14,
    "color": "red",
    "style": "bold"
  },
  {
    "text": "Verhalten zu Hause",
    "box": [40, 500, 820, 520],
    "size": 15,
    "color": "black",
    "style": "bold"
  },
  {
    "text": "Bleiben Sie im Gebäude, schließen Sie Fenster und Türen. Schalten Sie Ventilatoren und  Lüftungen aus. Vermeiden Sie unnötigen Sauerstoffverbrauch durch Kerzen oder Ähnliches. Bei radioaktiven Stoffen: suchen Sie einen Kellerraum auf",
    "box": [40, 525, 820, 580],
    "size": 14,
    "color": "black",
    "style": "normal"
  },
  {
    "text": "Verhalten im Auto oder im Freien",
    "box": [40, 590, 820, 615],
    "size": 15,
    "color": "black",
    "style": "bold"
  },
  {
    "text": "Bewegen Sie sich möglichst quer zur Windrichtung. Atmen Sie möglichst durch einen Atemschutz, zumindest durch ein Taschentuch. Waschen Sie Hände, Gesicht und Haare, ebenso Nase und Ohren mit Wasser und Seife. Bei biologischen Stoffen: desinfizieren Sie Ihre Hände zusätzlich.",
    "box": [40, 620, 820, 670],
    "size": 14,
    "color": "black",
    "style": "normal"
  }
]

topic_names__items = {
    "vorsorge": text_items__vorsorge,
    "feuer": text_items__feuer,
    "hochwasser": text_items__hochwasser,
    "gewitter": text_items__gewitter,
    "gefahrenstoffe": text_items__gefahrenstoffe,

}

import subprocess, json
from enum import Enum
from helpers import *
from img_helper import draw_text_boxes_1bit_mono
from remote_data import sensor__get_remote_data, sensor__items_to_textitems
from nina_warning_to_epd import build_text_items_from_warning

# class EinkTopic(Enum):
#     SLIDE0 = 0
#     SLIDE1 = 1
#     SLIDE2 = 2
#     SLIDE3 = 3
#     SLIDE4 = 4
#     MAIN = 5

# TODO: handle error
def gen__generic(text_items: list[dict], bw_path: str, rw_path: str, bw_outpath: str, rw_outpath: str) -> int:
    processed_items_bw = []
    processed_items_rw = []
    for item in text_items:
        try:
            text = item["text"]
            x1,y1,x2,y2 = item["box"]
            size = int(item["size"])
            color = COLOR_MAP.get(item.get("color","black"), (0,0,0))
            style = item.get("style","normal").lower()
            font_path = FONT_MAP.get(style, FONT_MAP["normal"])
            processed_item = {
                "text": text,
                "box": (x1,y1,x2,y2),
                "font_path": font_path,
                "size": size,
                "color": color,
                "align": "left",
                "valign": "top",
            }
            if item.get("color","black") == "black":
                processed_items_bw.append(processed_item)
            else:
                processed_items_rw.append(processed_item)
        except Exception:
            # ignore malformed entries per your spec
            continue
    draw_text_boxes_1bit_mono(
        image_path=bw_path,
        items=processed_items_bw,
        output_path=bw_outpath
    )
    draw_text_boxes_1bit_mono(
        image_path=rw_path,
        items=processed_items_rw,
        output_path=rw_outpath
    )
    return 0

def run_epd(exe_path: str, mode: str, black_bmp: str, ry_bmp: str):
    cmd = [exe_path, mode, str(black_bmp), str(ry_bmp)]
    try:
        print(cmd)
        code = subprocess.run(cmd)
    except Exception as e:
        print("Error running cmd: ", e)

def prepare_data_main_page(local_json_path: str = ""):
    # global current_topic
    text_items = []
    ## Sensors
    data_by_device = sensor__get_remote_data()
    sensor__text_items = sensor__items_to_textitems(data_by_device)
    text_items += sensor__text_items
    ## Remote warning
    data = {}
    if (local_json_path):
      print("## Load warning from local json: ", local_json_path)
      with open(local_json_path) as f:
          data = json.load(f)
    else:
      api_point = ""
      print("## Load warning from API: ", api_point)
      pass
    warning__text_items = build_text_items_from_warning(data)
    text_items += warning__text_items
    print(f"Data for MAIN: Textbausteine len={len(text_items)}!")
    return text_items

def run__slide(current_topic: EinkTopic, outdir: str, dry_run: bool = False):
    topic = ""
    bw_path = ""
    bw_outpath = ""
    rw_path = ""
    rw_outpath = ""
    items = []
    print("topic=",current_topic.value)
    # get data
    if current_topic == EinkTopic.SLIDE0:
        topic = "vorsorge"
        items = topic_names__items[topic]
    elif current_topic == EinkTopic.SLIDE1:
        topic = "feuer"
        items = topic_names__items[topic]
    elif current_topic == EinkTopic.SLIDE2:
        topic = "feuer"
        items = topic_names__items[topic]
    elif current_topic == EinkTopic.SLIDE3:
        topic = "gewitter"
        items = topic_names__items[topic]
    elif current_topic == EinkTopic.SLIDE4:
        topic = "gefahrenstoffe"
        items = topic_names__items[topic]
    else:
        topic = "kiezbox_sensor"
        meldung_id = "mow.DE-BR-B-SE017-20250909-17-001"
        local_json_path = f'static/{meldung_id}.json'
        items = prepare_data_main_page(local_json_path)
    #prepare paths
    bw_path = TEMPLATE_DIR + f"{topic}_black_white.bmp"
    bw_outpath = outdir + f"texted__{topic}_black_white.bmp"
    rw_path = TEMPLATE_DIR + f"{topic}_red_white.bmp"
    rw_outpath = outdir + f"texted__{topic}_red_white.bmp"
    #insert text and export to image
    gen__generic(items, bw_path, rw_path, bw_outpath, rw_outpath)

    #show eink
    # dry_run = True
    if dry_run:
      print("DRY RUN: plotting")
    else:
      run_epd(EPD_EXE_PATH, EPD_MODE, bw_outpath, rw_outpath)
